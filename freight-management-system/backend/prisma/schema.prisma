generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  COMPANY_ADMIN
  FINANCE_APPROVER
  OPERATIONS
  TRANSPORTER
  AGENT
  USER
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ShipmentStatus {
  PENDING
  PENDING_QUOTE
  QUOTE_SUBMITTED
  QUOTE_APPROVED
  REQUESTED
  ASSIGNED
  ACCEPTED
  PICKED_UP
  IN_TRANSIT
  DELIVERED
  CANCELLED
  REJECTED
}

enum QuoteStatus {
  PENDING
  RESPONDED
  APPROVED
  CLOSED
}

enum QuoteResponseStatus {
  PENDING
  RESPONDED
  APPROVED
  DECLINED
}

enum ConsentStatus {
  PENDING
  ACCEPTED
  DECLINED
  EXPIRED
}

enum BookingStatus {
  PENDING_TRANSPORTER
  CONFIRMED
  DECLINED
  EXPIRED
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  PAID
  FAILED
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
}

enum ComplianceStatus {
  PENDING
  SUBMITTED
  APPROVED
  REJECTED
  EXEMPT
}

enum DocumentType {
  GST_INVOICE
  SELF_INVOICE_RCM
  EWAY_BILL
  DRIVER_KYC
  VEHICLE_KYC
  LORRY_RECEIPT
}

model Company {
  id                 Int       @id @default(autoincrement())
  name               String
  webhookSecret      String
  plan               String    @default("standard")
  subscriptionStatus String    @default("active")
  billingEmail       String?
  billingCustomerId  String?
  trialEndsAt        DateTime?
  settings           Json?
  status             String    @default("active")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  users               User[]
  shipments           Shipment[]
  agreements          Agreement[]
  transporterInvoices TransporterInvoice[]
  invoices            Invoice[]
  profiles            CompanyProfile[]
  vendors             Vendor[]
}

model CompanyProfile {
  id           Int      @id @default(autoincrement())
  companyId    Int?
  legalName    String?
  gstin        String?
  pan          String?
  tan          String?
  addressLine1 String?
  addressLine2 String?
  city         String?
  state        String?
  postalCode   String?
  country      String?  @default("IN")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  company Company? @relation(fields: [companyId], references: [id])
}

model User {
  id             Int            @id @default(autoincrement())
  email          String         @unique
  passwordHash   String
  name           String?
  phone          String?
  role           Role           @default(USER)
  approvalStatus ApprovalStatus @default(PENDING)
  approvalNote   String?
  rejectionReason String?
  reviewedById   Int?
  reviewedAt     DateTime?
  isActive       Boolean        @default(true)
  vendorId       Int?
  companyId      Int?
  lastLoginAt    DateTime?
  notificationPreferences Json? @default("{}")
  twoFactorEnabled Boolean @default(false)
  twoFactorChannel String?  @default("email")
  allowedIpRanges Json?        @default("[]")
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  company             Company?             @relation(fields: [companyId], references: [id])
  vendor              Vendor?              @relation(fields: [vendorId], references: [id])
  shipments           Shipment[]           @relation("shipment_owner")
  assignedShipments   Shipment[]           @relation("assigned_to")
  notifications       Notification[]
  auditLogs           AuditLog[]
  agreementsReviewed  Agreement[]          @relation("agreement_reviewer")
  transporterInvoices TransporterInvoice[] @relation("approved_by")
  QuoteRequest        QuoteRequest[]
  passwordResetTokens PasswordResetToken[]
  twoFactorChallenges TwoFactorChallenge[]
  userConsents        UserConsent[]
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  tokenHash String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model TwoFactorChallenge {
  id        Int      @id @default(autoincrement())
  userId    Int
  codeHash  String
  expiresAt DateTime
  consumed  Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model UserConsent {
  id          Int           @id @default(autoincrement())
  userId      Int
  consentType String
  status      ConsentStatus @default(ACCEPTED)
  metadata    Json?
  recordedAt  DateTime      @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Vendor {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?
  phone     String?
  baseRate  Float?
  rating    Float?
  speed     Float?
  isActive  Boolean  @default(true)
  companyId Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company        Company?             @relation(fields: [companyId], references: [id])
  profile        VendorProfile?
  agreements     Agreement[]
  rateCards      RateCard[]
  quoteResponses QuoteResponse[]
  shipments      Shipment[]
  drivers        Driver[]
  User           User[]
}

model VendorProfile {
  id                  Int      @id @default(autoincrement())
  vendorId            Int      @unique
  legalName           String?
  gstin               String?  @unique
  pan                 String?
  tan                 String?
  addressLine1        String?
  addressLine2        String?
  city                String?
  state               String?
  postalCode          String?
  country             String?  @default("IN")
  rcmEligible         Boolean  @default(false)
  gstRegistrationType String?
  contactPerson       String?
  contactEmail        String?
  contactPhone        String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  vendor Vendor @relation(fields: [vendorId], references: [id])

  @@map("vendor_profiles")
}

model Driver {
  id            Int      @id @default(autoincrement())
  vendorId      Int
  name          String
  phone         String?
  licenseNumber String?
  vehicleNumber String?
  notes         String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  vendor Vendor @relation(fields: [vendorId], references: [id])
}

model Agreement {
  id            Int       @id @default(autoincrement())
  vendorId      Int
  title         String
  referenceCode String    @unique
  status        String    @default("DRAFT")
  effectiveFrom DateTime?
  effectiveTo   DateTime?
  notes         String?
  reviewedById  Int?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  vendor     Vendor     @relation(fields: [vendorId], references: [id])
  reviewedBy User?      @relation("agreement_reviewer", fields: [reviewedById], references: [id])
  rateCards  RateCard[]
  Company    Company?   @relation(fields: [companyId], references: [id])
  companyId  Int?
}

model RateCard {
  id            Int       @id @default(autoincrement())
  agreementId   Int
  routeName     String
  origin        String
  destination   String
  distanceKm    Float?
  ratePerKm     Float
  uom           String
  vehicleType   String
  effectiveFrom DateTime?
  remarks       String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  agreement Agreement @relation(fields: [agreementId], references: [id])
  Vendor    Vendor?   @relation(fields: [vendorId], references: [id])
  vendorId  Int?
  shipments Shipment[]
}

model QuoteRequest {
  id                 Int         @id @default(autoincrement())
  createdByUserId    Int
  fromLocation       String
  toLocation         String
  fromLat            Float?
  fromLng            Float?
  toLat              Float?
  toLng              Float?
  weight             Float?
  shipmentType       String?
  urgency            String?
  status             QuoteStatus @default(PENDING)
  notes              String?
  approvedResponseId Int?        @unique
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  createdBy        User            @relation(fields: [createdByUserId], references: [id])
  responses        QuoteResponse[]
  approvedResponse QuoteResponse?  @relation("approved_response", fields: [approvedResponseId], references: [id])
  shipment         Shipment?       @relation("quote_request_shipment")
}

model QuoteResponse {
  id                Int                 @id @default(autoincrement())
  quoteRequestId    Int
  vendorId          Int
  quotedPrice       Float?
  estimatedDelivery DateTime?
  expiresAt         DateTime?
  status            QuoteResponseStatus @default(PENDING)
  consentStatus     ConsentStatus       @default(PENDING)
  notes             String?
  transporterNotes  String?
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt

  quoteRequest QuoteRequest  @relation(fields: [quoteRequestId], references: [id])
  vendor       Vendor        @relation(fields: [vendorId], references: [id])
  shipment     Shipment?     @relation("shipment_quote")
  approvedFor  QuoteRequest? @relation("approved_response")
  consentLogs  ConsentLog[]
}

model ConsentLog {
  id              Int           @id @default(autoincrement())
  quoteResponseId Int
  shipmentId      Int?
  statusBefore    ConsentStatus
  statusAfter     ConsentStatus
  note            String?
  recordedAt      DateTime      @default(now())

  quoteResponse QuoteResponse @relation(fields: [quoteResponseId], references: [id])
  shipment      Shipment?     @relation(fields: [shipmentId], references: [id])
}

model Shipment {
  id                       Int              @id @default(autoincrement())
  userId                   Int
  companyId                Int?
  quoteRequestId           Int?             @unique
  transporterQuoteId       Int?             @unique
  selectedVendorId         Int?
  agreementId              Int?
  rateCardId               Int?
  trackingNumber           String?          @unique
  fromLocation             String
  toLocation               String
  fromLat                  Float?
  fromLng                  Float?
  toLat                    Float?
  toLng                    Float?
  weight                   Float?
  shipmentType             String?
  urgency                  String?
  status                   ShipmentStatus   @default(PENDING)
  bookingStatus            BookingStatus?
  paymentStatus            PaymentStatus?
  cost                     Float?
  distance                 Float?
  estimatedDelivery        DateTime?
  pickupTime               DateTime?
  deliveryTime             DateTime?
  assignedToId             Int?
  assignedDriver           String?
  driverPhone              String?
  driverEta                DateTime?
  transporterResponseNotes String?
  notes                    String?
  ewayBillNumber           String?
  gstInvoiceId             Int?
  complianceStatus         ComplianceStatus @default(PENDING)
  source                   String           @default("manual")
  podStatus                String           @default("Pending")
  podUrl                   String?
  podNotes                 String?
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt

  user                User                 @relation("shipment_owner", fields: [userId], references: [id])
  company             Company?             @relation(fields: [companyId], references: [id])
  quoteRequest        QuoteRequest?        @relation("quote_request_shipment", fields: [quoteRequestId], references: [id])
  transporterQuote    QuoteResponse?       @relation("shipment_quote", fields: [transporterQuoteId], references: [id])
  rateCard            RateCard?            @relation(fields: [rateCardId], references: [id])
  vendor              Vendor?              @relation(fields: [selectedVendorId], references: [id])
  assignedTo          User?                @relation("assigned_to", fields: [assignedToId], references: [id])
  statusHistory       StatusHistory[]
  complianceDocs      ComplianceDocument[]
  payments            Payment[]
  invoice             Invoice?
  consentLogs         ConsentLog[]
  transporterInvoices TransporterInvoice[]

  @@map("shipments")
}

model StatusHistory {
  id         Int            @id @default(autoincrement())
  shipmentId Int
  status     ShipmentStatus
  notes      String?
  latitude   Float?
  longitude  Float?
  location   String?
  updatedBy  Int?
  timestamp  DateTime       @default(now())

  shipment Shipment @relation(fields: [shipmentId], references: [id])
}

model Invoice {
  id            Int           @id @default(autoincrement())
  shipmentId    Int           @unique
  invoiceNumber String
  status        InvoiceStatus @default(DRAFT)
  issuedAt      DateTime?
  dueDate       DateTime?
  subtotal      Float         @default(0)
  taxTotal      Float         @default(0)
  grandTotal    Float         @default(0)
  lineItems     Json
  metadata      Json?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  shipment  Shipment  @relation(fields: [shipmentId], references: [id])
  payments  Payment[]
  Company   Company?  @relation(fields: [companyId], references: [id])
  companyId Int?
}

model Payment {
  id             Int           @id @default(autoincrement())
  shipmentId     Int
  invoiceId      Int
  amount         Float
  currency       String        @default("INR")
  status         PaymentStatus @default(PENDING)
  gateway        String        @default("MOCK")
  transactionRef String?
  authorizedAt   DateTime?
  capturedAt     DateTime?
  failureReason  String?
  metadata       Json?
  tdsAmount      Float?
  tcsAmount      Float?
  rcmLiability   Float?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  shipment Shipment       @relation(fields: [shipmentId], references: [id])
  invoice  Invoice        @relation(fields: [invoiceId], references: [id])
  events   PaymentEvent[]
}

model PaymentEvent {
  id         Int      @id @default(autoincrement())
  paymentId  Int
  eventType  String
  details    Json?
  recordedAt DateTime @default(now())

  payment Payment @relation(fields: [paymentId], references: [id])
}

model TransporterInvoice {
  id             Int       @id @default(autoincrement())
  companyId      Int
  shipmentId     Int
  invoiceNumber  String
  invoiceDate    DateTime
  invoiceAmount  Float
  invoiceUrl     String
  approvalStatus String    @default("Pending")
  rejectionNotes String?
  postedToErpAt  DateTime?
  approvedById   Int?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  company    Company  @relation(fields: [companyId], references: [id])
  shipment   Shipment @relation(fields: [shipmentId], references: [id])
  approvedBy User?    @relation("approved_by", fields: [approvedById], references: [id])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  title     String
  message   String
  type      String
  metadata  Json?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?
  action     String
  entityType String
  entityId   Int?
  details    Json?
  createdAt  DateTime @default(now())

  user User? @relation(fields: [userId], references: [id])
}

model ComplianceDocument {
  id         Int              @id @default(autoincrement())
  shipmentId Int
  type       DocumentType
  status     ComplianceStatus @default(PENDING)
  issuedAt   DateTime?
  fileUrl    String?
  payload    Json?
  metadata   Json?
  remarks    String?
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  shipment Shipment          @relation(fields: [shipmentId], references: [id])
  events   ComplianceEvent[]
}

model ComplianceEvent {
  id         Int      @id @default(autoincrement())
  documentId Int
  eventType  String
  details    Json?
  recordedAt DateTime @default(now())

  document ComplianceDocument @relation(fields: [documentId], references: [id])
}
